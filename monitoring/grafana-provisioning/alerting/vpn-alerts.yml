apiVersion: 1

groups:
  - name: vpn-handler-alerts
    orgId: 1
    folder: VPN Monitoring
    interval: 1m
    rules:
      - uid: vpn-critical-failure
        title: VPN Critical Failure
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: "loki"
            model:
              expr: 'count_over_time({component="VpnHandler", level="CRITICAL"}[5m]) > 0'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 0s
        annotations:
          description: "Critical VPN failure detected"
          summary: "VPN Handler has encountered a critical failure"
        labels:
          severity: critical
          component: vpn-handler

      - uid: vpn-rotation-failure-rate
        title: High VPN Rotation Failure Rate
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: "loki"
            model:
              expr: 'rate(count_over_time({component="VpnHandler", event_type="vpn_rotation_failed"}[15m])) > 0.1'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: "VPN rotation failure rate is above 10% over 15 minutes"
          summary: "High VPN rotation failure rate detected"
        labels:
          severity: warning
          component: vpn-handler

      - uid: vpn-ip-quota-exhausted
        title: IP Request Quota Nearly Exhausted
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: "loki"
            model:
              expr: 'count_over_time({component="VpnHandler", event_type="ip_quota_exceeded"}[5m]) > 0'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 0s
        annotations:
          description: "IP request quota is nearly exhausted, rotation may be needed"
          summary: "IP quota threshold exceeded"
        labels:
          severity: warning
          component: vpn-handler

      - uid: vpn-security-violation
        title: Security Violation Detected
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: "loki"
            model:
              expr: 'count_over_time({component="VpnHandler", event_type="security_violation_detected"}[5m]) > 0'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 0s
        annotations:
          description: "Security violation detected in VPN handler"
          summary: "VPN security violation"
        labels:
          severity: high
          component: vpn-handler

      - uid: vpn-reboot-required
        title: System Reboot Required
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: "loki"
            model:
              expr: 'count_over_time({component="VpnHandler", event_type="reboot_required_triggered"}[5m]) > 0'
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 0s
        annotations:
          description: "System reboot is required due to VPN failures"
          summary: "System reboot required"
        labels:
          severity: critical
          component: vpn-handler